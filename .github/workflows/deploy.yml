name: Deploy to EdgeOne Pages

on:
  push:
    branches: [ main ]  # å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# è®¾ç½®æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

# ç¡®ä¿åŒæ—¶åªæœ‰ä¸€ä¸ªéƒ¨ç½²åœ¨è¿è¡Œ
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build project with SEO enhancements
      run: npm run build
      env:
        NODE_ENV: production
        BASE_URL: /
        
      # éªŒè¯æ„å»ºç»“æœ
    - name: Verify build output
      run: |
        echo "ğŸ“ Build directory contents:"
        ls -la dist/
        echo ""
        echo "ğŸ“Š Build statistics:"
        find dist -type f -name "*.html" | wc -l
        echo "HTML files generated"
        
        # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f "dist/index.html" ]; then
          echo "âœ… Main index.html found"
        else
          echo "âŒ Main index.html missing"
          exit 1
        fi
        
        if [ -f "dist/ranking/index.html" ]; then
          echo "âœ… Ranking page generated"
        else
          echo "âŒ Ranking page missing"
        fi
        
        if [ -f "dist/topics/index.html" ]; then
          echo "âœ… Topics page generated"
        else
          echo "âŒ Topics page missing"
        fi
    
    - name: Check SEO content
      run: |
        # éªŒè¯SEOä¼˜åŒ–å†…å®¹æ˜¯å¦æ­£ç¡®ç”Ÿæˆ
        echo "ğŸ” Checking SEO content..."
        
        # æ£€æŸ¥é¦–é¡µæ˜¯å¦åŒ…å«AIå·¥å…·å¯¼èˆªæŒ‡å—
        if grep -q "AIå·¥å…·å¯¼èˆªçŸ¥è¯†é—¨æˆ·" dist/index.html; then
          echo "âœ… Homepage contains AI tool guide"
        else
          echo "âš ï¸  Homepage AI guide not found"
        fi
        
        # æ£€æŸ¥ç¿»è¯‘å·¥å…·é¡µé¢æ˜¯å¦åŒ…å«ä½¿ç”¨å¿ƒå¾—
        if [ -f "dist/translate/index.html" ]; then
          if grep -q "ä½¿ç”¨å¿ƒå¾—" dist/translate/index.html; then
            echo "âœ… Translate page contains usage insights"
          else
            echo "âš ï¸  Translate page usage insights not found"
          fi
        fi
        
        echo ""
        echo "ğŸ“ˆ Total static pages generated:"
        find dist -type f -name "*.html" | wc -l
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Pre-deployment verification
      run: |
        chmod +x scripts/pre-deploy-check.sh
        ./scripts/pre-deploy-check.sh
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './dist'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Display deployment info
      run: |
        echo "ğŸš€ Deployment successful!"
        echo "ğŸ“¦ Pages URL: ${{ steps.deployment.outputs.page_url }}"
        echo "ğŸŒ Your SEO-optimized site is now live!"
